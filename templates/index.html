<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Love Frame &lt; 3</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>Love Frame &lt; 3</h1>

    <div class="controls-container">
        <div class="upload-section">
            <input id="mediaInput" type="file" accept="image/*,video/*" />
            <button onclick="uploadMedia()">Send Photo/Video &lt; 3</button>
        </div>
        
        <div class="action-buttons">
            <button id="loveBtn">Send love &lt; 3</button>
            <button id="enableNotifs">Enable Notifications</button>
        </div>
    </div>

    <div id="mediaContainer"></div>

    <script>
        const VAPID_PUBLIC_KEY = "BDufO492Sr7_QdxO_QVHGm3-nkJ7TddlcuBRSN9eI202SXrgd6MCvO0W_gCIdvzCyEcTI0N8afPKZy0Q4TWZpqY";
    
        // Generate or reuse a unique senderId per device
        let senderId = localStorage.getItem("senderId");
        if (!senderId) {
            senderId = crypto.randomUUID();
            localStorage.setItem("senderId", senderId);
        }
    
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
        }
    
        async function setupNotifications() {
            const reg = await navigator.serviceWorker.register("/service-worker.js");
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                alert("Please allow notifications to continue.");
                return;
            }
    
            const oldSub = await reg.pushManager.getSubscription();
            if (oldSub) await oldSub.unsubscribe();
    
            const newSub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
    
            console.log("Subscription created:", newSub);
    
            await fetch("/save-subscription", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ senderId, subscription: newSub })
            });
    
            alert("Notifications enabled successfully! <3");
        }
    
        document.getElementById("enableNotifs").onclick = setupNotifications;
    
        // Send love button handler
        document.getElementById("loveBtn").onclick = async () => {
            const res = await fetch("/sendlove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ senderId })
            });
            if (res.ok) alert("Love sent!");
        };
    
        // Upload media function
        async function uploadMedia() {
            const fileInput = document.getElementById("mediaInput");
            if (!fileInput.files.length) {
                alert("Please select a file first!");
                return;
            }
    
            const formData = new FormData();
            formData.append("media", fileInput.files[0]);
    
            const res = await fetch("/uploads", { method: "POST", body: formData });
            if (res.ok) alert("Media sent!");
        }
    </script>

</body>
</html>
