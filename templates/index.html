<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Love Frame</title>
</head>
<body>
    <h1>Love Frame</h1>

    <input id="mediaInput" type="file" accept="image/*,video/*" />
    <button onclick="uploadMedia()">Send Photo/Video</button>
    <button id="loveBtn">Send love</button>
    <button id="enableNotifs">Enable Notifications</button>

    <div id="mediaContainer"></div>

    <script>
            console.log("Love App Version: 2.0 (BroadcastChannel)");
    
            // 1. SETUP THE RADIO CHANNEL (Listens for updates from Service Worker)
            const channel = new BroadcastChannel('love-channel');
            channel.onmessage = (event) => {
                console.log("Radio received:", event.data);
                if (event.data.type === 'MEDIA_UPDATE' && event.data.url) {
                    showMedia(event.data.url);
                }
            };
    
            // 2. HELPER FUNCTIONS
            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
            }
    
            function showMedia(url) {
                const box = document.getElementById("mediaContainer");
                box.innerHTML = ""; // Clear old stuff
                
                // Ensure URL is clean
                const cleanUrl = decodeURIComponent(url);
    
                if (cleanUrl.match(/\.(mp4|webm)$/i)) {
                    box.innerHTML = `<video controls autoplay playsinline src="${cleanUrl}" style="max-width:100%"></video>`;
                } else {
                    // Assume image if not video
                    box.innerHTML = `<img src="${cleanUrl}" style="max-width:100%" />`;
                }
                box.innerHTML += `<p><a href="/">Back to home</a></p>`;
            }
    
            async function uploadMedia() {
                const file = document.getElementById("mediaInput").files[0];
                if (!file) return alert("Select a photo or video!");
                
                const btn = document.querySelector('button[onclick="uploadMedia()"]');
                btn.disabled = true;
                btn.innerText = "Sending...";
    
                const fd = new FormData();
                fd.append("media", file);
    
                try {
                    const res = await fetch("/uploads", { method: "POST", body: fd });
                    if (res.ok) {
                        alert("Sent with love <3");
                        // Optional: Show it to yourself too
                        // showMedia("/uploads/" + file.name); 
                    } else {
                        alert("Upload failed.");
                    }
                } catch (e) {
                    alert("Error sending: " + e);
                }
                btn.disabled = false;
                btn.innerText = "Send Photo/Video";
            }
    
            // 3. SETUP NOTIFICATIONS & SERVICE WORKER
            async function setupNotifications() {
                // Note: I changed the SW name to sw.js to FORCE an update. 
                // You must rename your file in app.py and your file system too!
                const reg = await navigator.serviceWorker.register("/sw.js");
    
                const permission = await Notification.requestPermission();
                if (permission !== "granted") return alert("Please allow notifications!");
    
                const sub = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array("BDufO492Sr7_QdxO_QVHGm3-nkJ7TddlcuBRSN9eI202SXrgd6MCvO0W_gCIdvzCyEcTI0N8afPKZy0Q4TWZpqY")
                });
    
                await fetch("/save-subscription", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(sub)
                });
    
                alert("Notifications enabled! <3");
            }
    
            document.getElementById("enableNotifs").onclick = setupNotifications;
            document.getElementById("loveBtn").onclick = async () => {
                await fetch("/sendlove");
                alert("Love sent!");
            };
    
            // 4. CHECK URL ON LOAD
            const params = new URLSearchParams(location.search);
            if (params.has("media")) {
                showMedia(params.get("media"));
            }
        </script>
</body>
</html>
