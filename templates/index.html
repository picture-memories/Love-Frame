<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Love Frame &lt; 3</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    
</head>
<body>
    <h1>Love Frame &lt; 3</h1>

    <div class="controls-container">
        <div class="upload-section">
            <input id="mediaInput" type="file" accept="image/*,video/*" />
            <button onclick="uploadMedia()">Send Photo/Video &lt; 3</button>
        </div>
        
        <div class="action-buttons">
            <button id="loveBtn">Send love &lt; 3</button>
            <button id="enableNotifs">Enable Notifications</button>
        </div>
    </div>

    <div id="mediaContainer"></div>

    <script>
        // Convert VAPID public key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
        }
    
        const VAPID_PUBLIC_KEY = "BGo3VOylu5Ao74-A19aXoFUprZycvRa9KO2_-oZO9_30kpLqkIbKtx3XDdFBIMaHFHhHPXUi_3V9Vnl1YRAj6rk";
    
        async function setupNotifications() {
            console.log("Registering service worker...");
            const reg = await navigator.serviceWorker.register("/service-worker.js");
    
            // 1. Ask permission
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                alert("Please allow notifications to continue.");
                return;
            }
    
            // 2. Remove old subscription (prevents BadJwtToken)
            const oldSub = await reg.pushManager.getSubscription();
            if (oldSub) {
                console.log("Unsubscribing old push subscription...");
                await oldSub.unsubscribe();
            }
    
            // 3. Create NEW subscription with NEW VAPID key
            console.log("Creating new push subscription...");
            const newSub = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
    
            console.log("Subscription created:", newSub);
    
            // 4. Save subscription to server
            await fetch("/save-subscription", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newSub)
            });
    
            alert("Notifications enabled successfully! <3");
        }
    
        document.getElementById("enableNotifs").onclick = setupNotifications;
    </script>

</body>
</html>
